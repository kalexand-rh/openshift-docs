[[install-config-install-disconnected-install]]
= Disconnected installation
{product-author}
{product-version}
:latest-tag: v3.10.34
:latest-int-tag: v3.10.34
:latest-registry-console-tag: v3.10.34
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

Frequently, portions of a data center might not have access to the Internet, even
via proxy servers. You can still install {product-title} in these environments,
but you must download required software and images and make them available to
the disconnected environment.

After the installation components are available to your node hosts, you install
{product-title} by following the standard installation steps.

After you install {product-title}, you must make the S2I builder images that you
pulled available to the cluster.

[[disconnected-prerequisites]]
== Prerequisites

* Review
xref:../architecture/index.adoc#architecture-index[{product-title}'s overall architecture]
and plan your environment topology.

* Obtain a Red Hat Enterprise Linux (RHEL) 7 server that you have root access to
with access to the Internet and at least 110 GB of disk space. You download the
required software repositories and container images to this computer.

* Plan to add a webserver within your disconnected environment to serve the software and
required images. If your organization's policies allow you to move the RHEL 7
server that you download the required software repositories and container images
to into your disconnected LAN, you can plan to reuse that server. If you cannot
move the server into your disconnected LAN, then you create a separate webserver
during installation preparation.

* Provide a source control repository. After installation, your nodes must
access source code in a source code repository, such as
Git.

When building applications in {product-title}, your build might contain
external dependencies, such as a Maven Repository or Gem files for Ruby
applications.

[NOTE]
====
You can use a
http://www.redhat.com/en/technologies/linux-platforms/satellite[Red Hat
Satellite] server to provides access to Red Hat content via an intranet or
LAN. For environments with Satellite, you can synchronize the {product-title}
software onto the Satellite for use with the {product-title} servers.

https://access.redhat.com/documentation/en/red-hat-satellite/[Red Hat Satellite
6.1] also introduces the ability to act as a Docker registry, and it can be used
to host the {product-title} containerized components. Doing so is outside of the
scope of this document.
====

////
For this reason, and because they might require certain tags, many
of the Quickstart templates offered by {product-title} might not work on a
disconnected environment. However, while Red Hat container images try to reach out
to external repositories by default, you can configure {product-title} to use
your own internal repositories. For the purposes of this document, we assume
that such internal repositories already exist and are accessible from the
{product-title} nodes hosts. Installing such repositories is outside the scope
of this document.
////

[[disconnected-required-software-and-components]]
== Obtaining required software packages and images

Before you install {product-title} in your disconnected environment, obtain the
required images and components and store them in your repository.

[[disconnected-syncing-repos]]
=== Obtaining {product-title} packages

On the RHEL 7 server with an internet connection, sync the repositories:

. To ensure that the packages are not deleted after you sync the repository,
import the GPG key:
+
[source, bash]
----
$ rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
----

. Register the server with the Red Hat Customer Portal. You must use the 
credentials that are associated with the account that has access to the
{product-title} subscriptions:
+
[source, bash]
----
$ subscription-manager register
----

. Pull the latest subscription data from RHSM:
+
[source, bash]
----
$ subscription-manager refresh
----

. Attach a subscription that provides {product-title} channels.
.. Find an available subscription pool that provides the {product-title}
channels:
+
[source, bash]
----
$ subscription-manager list --available --matches '*OpenShift*'
----

.. Attach a pool ID for a subscription that provides {product-title}:
+
[source, bash]
----
$ subscription-manager attach --pool=<pool_id>
$ subscription-manager repos --disable="*"
$ subscription-manager repos \
    --enable="rhel-7-server-rpms" \
    --enable="rhel-7-server-extras-rpms" \
    --enable="rhel-7-server-ansible-2.6-rpms" \
    --enable="rhel-7-server-ose-3.10-rpms"
----

. Install required packages:
+
[source, bash]
----
$ sudo yum -y install yum-utils createrepo docker git
----
+
The `yum-utils` package provides the *reposync* utility, which lets you mirror
yum repositories, and you can use the `createrepo` to create a usable `yum`
repository from a directory.

. Make a directory to store the software in the server's storage or to a USB
drive or other external device:
+
[source, bash]
----
$ mkdir -p </path/to/repos>
----
+
[IMPORTANT]
====
If you can re-connect this server to the disconnected LAN and use it as the
repository server, store the files locally. If you cannot,
use USB-connected storage so you can transport the software to a repository
server in your disconnected LAN.
====

. Sync the packages and create the repository for each of them:
+
[source, bash]
----
$ for repo in \
rhel-7-server-rpms \
rhel-7-server-extras-rpms \
rhel-7-server-ansible-2.6-rpms \
rhel-7-server-ose-3.10-rpms
do
  reposync --gpgcheck -lm --repoid=${repo} --download_path=</path/to/repos> <1>
  createrepo -v </path/to/repos/>${repo} -o </path/to/repos/>${repo} <1>
done
----
<1> Provide the path to the directory you created.

[[disconnected-syncing-images]]
=== Obtaining images

Pull the required container images:

. Start the Docker daemon:
+
[source, bash]
----
$ systemctl start docker
----

. Pull all of the required {product-title} infrastructure component images.
ifdef::openshift-enterprise[]
Replace `<tag>` with `{latest-tag}` for the latest version.
endif::[]
+
[source, bash]
----
$ docker pull registry.access.redhat.com/openshift3/csi-attacher:<tag>
$ docker pull registry.access.redhat.com/openshift3/csi-driver-registrar:<tag>
$ docker pull registry.access.redhat.com/openshift3/csi-livenessprobe:<tag>
$ docker pull registry.access.redhat.com/openshift3/csi-provisioner:<tag>
$ docker pull registry.access.redhat.com/openshift3/efs-provisioner:<tag>
$ docker pull registry.access.redhat.com/openshift3/image-inspector:<tag>
$ docker pull registry.access.redhat.com/openshift3/local-storage-provisioner:<tag>
$ docker pull registry.access.redhat.com/openshift3/manila-provisioner:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-ansible:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-cli:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-cluster-capacity:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-deployer:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-descheduler:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-docker-builder:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-docker-registry:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-egress-dns-proxy:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-egress-http-proxy:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-egress-router:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-f5-router:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-haproxy-router:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-hyperkube:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-hypershift:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-keepalived-ipfailover:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-pod:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-node-problem-detector:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-recycler:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-web-console:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-node:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-control-plane:<tag>
$ docker pull registry.access.redhat.com/openshift3/registry-console:<tag>
$ docker pull registry.access.redhat.com/openshift3/snapshot-controller:<tag>
$ docker pull registry.access.redhat.com/openshift3/snapshot-provisioner:<tag>
$ docker pull registry.access.redhat.com/rhel7/etcd:3.2.22

----

////
[NOTE]
====
If you use NFS, you need the `ose-recycler` image. Otherwise, the volumes
will not recycle, potentially causing errors.
====
////

. Pull all of the required {product-title} component images for the
additional centralized log aggregation and metrics aggregation components.
ifdef::openshift-enterprise[]
Replace `<tag>` with `{latest-int-tag}` for the latest version.
endif::[]
+
[source, bash]
----
$ docker pull registry.access.redhat.com/openshift3/logging-auth-proxy:<tag>
$ docker pull registry.access.redhat.com/openshift3/logging-curator:<tag>
$ docker pull registry.access.redhat.com/openshift3/logging-elasticsearch:<tag>
$ docker pull registry.access.redhat.com/openshift3/logging-eventrouter:<tag>
$ docker pull registry.access.redhat.com/openshift3/logging-fluentd:<tag>
$ docker pull registry.access.redhat.com/openshift3/logging-kibana:<tag>
$ docker pull registry.access.redhat.com/openshift3/oauth-proxy:<tag>
$ docker pull registry.access.redhat.com/openshift3/metrics-cassandra:<tag>
$ docker pull registry.access.redhat.com/openshift3/metrics-hawkular-metrics:<tag>
$ docker pull registry.access.redhat.com/openshift3/metrics-hawkular-openshift-agent:<tag>
$ docker pull registry.access.redhat.com/openshift3/metrics-heapster:<tag>
$ docker pull registry.access.redhat.com/openshift3/metrics-schema-installer:<tag>
$ docker pull registry.access.redhat.com/openshift3/prometheus:<tag>
$ docker pull registry.access.redhat.com/openshift3/prometheus-alert-buffer:<tag>
$ docker pull registry.access.redhat.com/openshift3/prometheus-alertmanager:<tag>
$ docker pull registry.access.redhat.com/openshift3/prometheus-node-exporter:<tag>
$ docker pull registry.access.redhat.com/cloudforms46/cfme-openshift-postgresql
$ docker pull registry.access.redhat.com/cloudforms46/cfme-openshift-memcached
$ docker pull registry.access.redhat.com/cloudforms46/cfme-openshift-app-ui
$ docker pull registry.access.redhat.com/cloudforms46/cfme-openshift-app
$ docker pull registry.access.redhat.com/cloudforms46/cfme-openshift-embedded-ansible
$ docker pull registry.access.redhat.com/cloudforms46/cfme-openshift-httpd
$ docker pull registry.access.redhat.com/cloudforms46/cfme-httpd-configmap-generator
$ docker pull registry.access.redhat.com/rhgs3/rhgs-server-rhel7
$ docker pull registry.access.redhat.com/rhgs3/rhgs-volmanager-rhel7
$ docker pull registry.access.redhat.com/rhgs3/rhgs-gluster-block-prov-rhel7
$ docker pull registry.access.redhat.com/rhgs3/rhgs-s3-server-rhel7
----
+
[IMPORTANT]
====
For Red Hat support, a {gluster-native} subscription is required for `rhgs3/` images.
====
+
[IMPORTANT]
====
Prometheus on {product-title} is a Technology Preview feature only.
ifdef::openshift-enterprise[]
Technology Preview features are not supported with Red Hat production service
level agreements (SLAs), might not be functionally complete, and Red Hat does
not recommend to use them for production. These features provide early access to
upcoming product features, enabling customers to test functionality and provide
feedback during the development process.

For more information on Red Hat Technology Preview features support scope, see
https://access.redhat.com/support/offerings/techpreview/.
endif::[]
====

. For the service catalog, OpenShift Ansible broker, and template service broker
features, as described in
xref:configuring_inventory_file.adoc#enabling-service-catalog[Configuring Your Inventory File],
pull the following images.
ifdef::openshift-enterprise[]
Replace `<tag>` with `{latest-tag}` for the latest version.
endif::[]
+
[source, bash]
----
$ docker pull registry.access.redhat.com/openshift3/apb-base:<tag>
$ docker pull registry.access.redhat.com/openshift3/apb-tools:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-service-catalog:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-ansible-service-broker:<tag>
$ docker pull registry.access.redhat.com/openshift3/mariadb-apb:<tag>
$ docker pull registry.access.redhat.com/openshift3/mediawiki-apb:<tag>
$ docker pull registry.access.redhat.com/openshift3/mysql-apb:<tag>
$ docker pull registry.access.redhat.com/openshift3/ose-template-service-broker:<tag>
$ docker pull registry.access.redhat.com/openshift3/postgresql-apb:<tag>
----

. Pull the Red Hat-certified
xref:../architecture/core_concepts/builds_and_image_streams.adoc#source-build[Source-to-Image
(S2I)] builder images that you intend to use in your {product-title} environment.
+
Make sure to indicate the correct tag by specifying the version number. See the
S2I table in the link:https://access.redhat.com/articles/2176281[OpenShift and Atomic Platform Tested Integrations page]
for details about image version compatibility.
+
////
For example, to pull both the previous and latest version of the Tomcat image:
+
[source, bash]
----
$ docker pull \
registry.access.redhat.com/jboss-webserver-3/webserver30-tomcat7-openshift:latest
$ docker pull \
registry.access.redhat.com/jboss-webserver-3/webserver30-tomcat7-openshift:1.1
----
////
+
You can pull the following images:
+
[source, bash]
----
$ docker pull registry.access.redhat.com/jboss-amq-6/amq63-openshift
$ docker pull registry.access.redhat.com/jboss-datagrid-7/datagrid71-openshift
$ docker pull registry.access.redhat.com/jboss-datagrid-7/datagrid71-client-openshift
$ docker pull registry.access.redhat.com/jboss-datavirt-6/datavirt63-openshift
$ docker pull registry.access.redhat.com/jboss-datavirt-6/datavirt63-driver-openshift
$ docker pull registry.access.redhat.com/jboss-decisionserver-6/decisionserver64-openshift
$ docker pull registry.access.redhat.com/jboss-processserver-6/processserver64-openshift
$ docker pull registry.access.redhat.com/jboss-eap-6/eap64-openshift
$ docker pull registry.access.redhat.com/jboss-eap-7/eap70-openshift
$ docker pull registry.access.redhat.com/jboss-webserver-3/webserver31-tomcat7-openshift
$ docker pull registry.access.redhat.com/jboss-webserver-3/webserver31-tomcat8-openshift
$ docker pull registry.access.redhat.com/openshift3/jenkins-1-rhel7
$ docker pull registry.access.redhat.com/openshift3/jenkins-2-rhel7
$ docker pull registry.access.redhat.com/openshift3/jenkins-agent-maven-35-rhel7:<tag>
$ docker pull registry.access.redhat.com/openshift3/jenkins-agent-nodejs-8-rhel7:<tag>
$ docker pull registry.access.redhat.com/openshift3/jenkins-slave-base-rhel7
$ docker pull registry.access.redhat.com/openshift3/jenkins-slave-maven-rhel7
$ docker pull registry.access.redhat.com/openshift3/jenkins-slave-nodejs-rhel7
$ docker pull registry.access.redhat.com/rhscl/mongodb-32-rhel7
$ docker pull registry.access.redhat.com/rhscl/mysql-57-rhel7
$ docker pull registry.access.redhat.com/rhscl/perl-524-rhel7
$ docker pull registry.access.redhat.com/rhscl/php-56-rhel7
$ docker pull registry.access.redhat.com/rhscl/postgresql-95-rhel7
$ docker pull registry.access.redhat.com/rhscl/python-35-rhel7
$ docker pull registry.access.redhat.com/redhat-sso-7/sso70-openshift
$ docker pull registry.access.redhat.com/rhscl/ruby-24-rhel7
$ docker pull registry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift
$ docker pull registry.access.redhat.com/redhat-sso-7/sso71-openshift
$ docker pull registry.access.redhat.com/rhscl/nodejs-6-rhel7
$ docker pull registry.access.redhat.com/rhscl/mariadb-101-rhel7
----

[[disconnected-preparing-images-for-export]]
=== Exporting images

Export the images into compressed files:

. Create a directory to store your compressed images in and change to it:
+
[source, bash]
----
$ mkdir </path/to/repos/images>
$ cd </path/to/repos/images>
----
+
Make the new directory in the same location as the directory that you stored
the software in.

. Export the {product-title} infrastructure component images:
+
[source, bash]
----
$ docker save -o ose3-images.tar \
    registry.access.redhat.com/openshift3/apb-base \
    registry.access.redhat.com/openshift3/apb-tools \
    registry.access.redhat.com/openshift3/csi-attacher \
    registry.access.redhat.com/openshift3/csi-driver-registrar \
    registry.access.redhat.com/openshift3/csi-livenessprobe \
    registry.access.redhat.com/openshift3/csi-provisioner \
    registry.access.redhat.com/openshift3/efs-provisioner \
    registry.access.redhat.com/openshift3/image-inspector \
    registry.access.redhat.com/openshift3/local-storage-provisioner \
    registry.access.redhat.com/openshift3/manila-provisioner \
    registry.access.redhat.com/openshift3/mariadb-apb \
    registry.access.redhat.com/openshift3/mediawiki-apb \
    registry.access.redhat.com/openshift3/mysql-apb \
    registry.access.redhat.com/openshift3/ose-ansible \
    registry.access.redhat.com/openshift3/ose-ansible-service-broker \
    registry.access.redhat.com/openshift3/ose-cli \
    registry.access.redhat.com/openshift3/ose-cluster-capacity \
    registry.access.redhat.com/openshift3/ose-deployer \
    registry.access.redhat.com/openshift3/ose-descheduler \
    registry.access.redhat.com/openshift3/ose-docker-builder \
    registry.access.redhat.com/openshift3/ose-docker-registry \
    registry.access.redhat.com/openshift3/ose-egress-dns-proxy \
    registry.access.redhat.com/openshift3/ose-egress-http-proxy \
    registry.access.redhat.com/openshift3/ose-egress-router \
    registry.access.redhat.com/openshift3/ose-f5-router \
    registry.access.redhat.com/openshift3/ose-haproxy-router \
    registry.access.redhat.com/openshift3/ose-hyperkube \
    registry.access.redhat.com/openshift3/ose-hypershift \
    registry.access.redhat.com/openshift3/ose-keepalived-ipfailover \
    registry.access.redhat.com/openshift3/ose-node-problem-detector \
    registry.access.redhat.com/openshift3/ose-recycler \
    registry.access.redhat.com/openshift3/ose-pod \
    registry.access.redhat.com/openshift3/ose-service-catalog \
    registry.access.redhat.com/openshift3/ose-template-service-broker \
    registry.access.redhat.com/openshift3/ose-web-console \
    registry.access.redhat.com/openshift3/registry-console \
    registry.access.redhat.com/openshift3/postgresql-apb \
    registry.access.redhat.com/openshift3/prometheus \
    registry.access.redhat.com/openshift3/prometheus-alert-buffer \
    registry.access.redhat.com/openshift3/prometheus-alertmanager \
    registry.access.redhat.com/openshift3/prometheus-node-exporter \
    registry.access.redhat.com/openshift3/snapshot-controller \
    registry.access.redhat.com/openshift3/snapshot-provisioner \
    registry.access.redhat.com/rhel7/etcd:3.2.22 \
    registry.access.redhat.com/cloudforms46/cfme-openshift-postgresql \
    registry.access.redhat.com/cloudforms46/cfme-openshift-memcached \
    registry.access.redhat.com/cloudforms46/cfme-openshift-app-ui \
    registry.access.redhat.com/cloudforms46/cfme-openshift-app \
    registry.access.redhat.com/cloudforms46/cfme-openshift-embedded-ansible \
    registry.access.redhat.com/cloudforms46/cfme-openshift-httpd \
    registry.access.redhat.com/cloudforms46/cfme-httpd-configmap-generator \
    registry.access.redhat.com/rhgs3/rhgs-server-rhel7 \
    registry.access.redhat.com/rhgs3/rhgs-volmanager-rhel7 \
    registry.access.redhat.com/rhgs3/rhgs-gluster-block-prov-rhel7 \
    registry.access.redhat.com/rhgs3/rhgs-s3-server-rhel7
----
////
+
[IMPORTANT]
====
For Red Hat support, a {gluster-native} subscription is required for `rhgs3/` images.
====
////

. If you synchronized the metrics and log aggregation images, export them:
+
[source, bash]
----
$ docker save -o ose3-logging-metrics-images.tar \
    registry.access.redhat.com/openshift3/logging-auth-proxy \
    registry.access.redhat.com/openshift3/logging-curator \
    registry.access.redhat.com/openshift3/logging-eventrouter \
    registry.access.redhat.com/openshift3/logging-elasticsearch \
    registry.access.redhat.com/openshift3/logging-fluentd \
    registry.access.redhat.com/openshift3/logging-kibana \
    registry.access.redhat.com/openshift3/metrics-cassandra \
    registry.access.redhat.com/openshift3/metrics-hawkular-metrics \
    registry.access.redhat.com/openshift3/metrics-hawkular-openshift-agent \
    registry.access.redhat.com/openshift3/metrics-heapster \
    registry.access.redhat.com/openshift3/metrics-schema-installer
----

. Export the S2I builder images that you pulled. For
example, if you synced only the Jenkins and Tomcat images:
+
[source, bash]
----
$ docker save -o ose3-builder-images.tar \
    registry.access.redhat.com/jboss-webserver-3/webserver31-tomcat7-openshift:latest \
    registry.access.redhat.com/jboss-webserver-3/webserver31-tomcat8-openshift:latest \
    registry.access.redhat.com/openshift3/jenkins-1-rhel7 \
    registry.access.redhat.com/openshift3/jenkins-2-rhel7 \
    registry.access.redhat.com/openshift3/jenkins-agent-maven-35-rhel7 \
    registry.access.redhat.com/openshift3/jenkins-agent-nodejs-8-rhel7 \
    registry.access.redhat.com/openshift3/jenkins-slave-base-rhel7 \
    registry.access.redhat.com/openshift3/jenkins-slave-maven-rhel7 \
    registry.access.redhat.com/openshift3/jenkins-slave-nodejs-rhel7
----

[[disconnected-repo-server]]
== Prepare and populate the repository server

During the installation, and any future updates, you
need a webserver to host the repositories. RHEL 7 can provide the Apache
webserver.

. Prepare the webserver:
.. If you need to install a new webserver in your disconnected environment,
install a new RHEL 7 system with at least 110 GB of space on your LAN. During
RHEL installation, select the *Basic Web Server* option.
.. If you are re-using the server where you downloaded the {product-title}
software and required images, install Apache on the server:
+
[source, bash]
----
$ sudo yum install httpd
----

. Place the repository files into Apache’s root folder.
** If you are re-using the server:
+
[source, bash]
----
$ mv /path/to/repos /var/www/html/
$ chmod -R +r /var/www/html/repos
$ restorecon -vR /var/www/html
----

** If you installed a new server, attach external storage and then copy the
files:
+
[source, bash]
----
$ cp -a /path/to/repos /var/www/html/
$ chmod -R +r /var/www/html/repos
$ restorecon -vR /var/www/html
----

. Add the firewall rules:
+
[source, bash]
----
$ sudo firewall-cmd --permanent --add-service=http
$ sudo firewall-cmd --reload
----

. Enable and start Apache for the changes to take effect:
+
[source, bash]
----
$ systemctl enable httpd
$ systemctl start httpd
----

[[disconnected-openshift-systems]]
== Preparing cluster hosts

Now that you have the installation files, prepare your hosts.

. Create the hosts for your {product-title} cluster. It is recommended to use
the latest version of RHEL 7 and to perform a minimal installation. Ensure that
the hosts meet the 
xref:../install/prerequisites.adoc#install-config-install-prerequisites[system
requirements].

. On each node host, create the repository definitions. Place the following text
in the *_/etc/yum.repos.d/ose.repo_* file:
+
----
[rhel-7-server-rpms]
name=rhel-7-server-rpms
baseurl=http://<server_IP>/repos/rhel-7-server-rpms <1>
enabled=1
gpgcheck=0
[rhel-7-server-extras-rpms]
name=rhel-7-server-extras-rpms
baseurl=http://<server_IP>/repos/rhel-7-server-extras-rpms <1>
enabled=1
gpgcheck=0
[rhel-7-server-ansible-2.6-rpms]
name=rhel-7-server-ansible-2.6-rpms
baseurl=http://<server_IP>/repos/rhel-7-server-ansible-2.6-rpms <1>
enabled=1
gpgcheck=0
[rhel-7-server-ose-3.10-rpms]
name=rhel-7-server-ose-3.10-rpms
baseurl=http://<server_IP>/repos/rhel-7-server-ose-3.10-rpms <1>
enabled=1
gpgcheck=0
----
<1> Replace `<server_IP>` with the IP address or host name of the Apache server
that hosts the software repositories.

. To import the relevant software and images, securely copy the images from the
webserver to the individual {product-title} hosts:
+
[source, bash]
----
$ scp /var/www/html/repos/images/ose3-images.tar root@<openshift_host_name>:
$ ssh root@<openshift_host_name> "docker load -i ose3-images.tar"
$ scp /var/www/html/images/ose3-builder-images.tar root@<openshift_master_host_name>:
$ ssh root@<openshift_master_host_name> "docker load -i ose3-builder-images.tar"
$ scp /var/www/html/images/ose3-builder-images.tar root@<openshift_master_host_name>:
$ ssh root@<openshift_master_host_name> "docker load -i ose3-logging-metrics-images.tar"
----

. Finish preparing the hosts for installation. Follow the
xref:host_preparation.adoc#install-config-install-host-preparation[Preparing your hosts]
steps, omitting the steps in the *Host Registration* section.

[[disconnected-installing-openshift]]
== Installing {product-title}

After you prepare the hosts in your disconnected environment:
* xref:configuring_inventory_file.adoc#configuring-ansible[Configure your
inventory file].
* xref:running_install.adoc#install-running-installation-playbooks[Run the
installation playbooks].

[IMPORTANT]
====
For
xref:index.adoc#planning-installation-types[system container installations] on
RHEL Atomic Host, to install the etcd container, you can set the Ansible variable
`osm_etcd_image` to be the fully qualified name of the etcd image on
your local registry, for example, `registry.example.com/rhel7/etcd`.
====

[NOTE]
====
If you want to
xref:stand_alone_registry.adoc#install-config-installing-stand-alone-registry[install a stand-alone registry],
you must xref:disconnected-syncing-images[pull the *registry-console* container image]
and set `deployment_subtype=registry` in your inventory file.
====

[[disconnected-re-tagging-s2i-builder-images]]
== Configuring S2I builder images and streams

Because the Internet is not available to pull the S2I builder images from Red
Hat's registry, you must make the images available in another Docker registry.

You can store the S2I builder images in the internal registry that stores the
images that are built during the S2I process. If you configured a different
registry during {product-title} installation, you can use that one instead.

The following steps use the default registry and the default values for the
service IP subnet (172.30.0.0/16) and the Docker registry port (5000).

. Create a new user with *cluster-admin* privileges so you can push the container
images into {product-title}'s Docker registry. Because the default
{product-title} system administrator does not have a standard authorization
token, you cannot use that account to log in to the Docker registry.
.. Create a new account in the authentication system that you use with
{product-title}. For example, if you are using local `htpasswd`-based
authentication:
+
[source, bash]
----
$ htpasswd -b /etc/openshift/openshift-passwd <admin_username> <password>
----

.. Log in to {product-title} as the new user to create that account in the
{product-title} database. If you use the self-signed certificates generated 
during installation:
+
[source, bash]
----
$ oc login --certificate-authority=/etc/origin/master/ca.crt \
    -u <admin_username> https://<openshift_master_host>:8443
----

.. Obtain the user’s authentication token:
+
[source, bash]
----
$ MYTOKEN=$(oc whoami -t)
$ echo $MYTOKEN
iwo7hc4XilD2KOLL4V1O55ExH2VlPmLD-W2-JOd6Fko
----
+
You need the token in a later step.

.. To grant privileges to the new user, log in as the {product-title}
system administrator:
+
[source, bash]
----
$ oc login -u system:admin
----

.. Grant the `image-builder` security role to the new user so you can push images
into the {product-title} Docker registry:
+
[source, bash]
----
$ oc adm policy add-role-to-user system:image-builder <admin_username>
----

.. Grant the administrative role to the new user in the *openshift* project so 
you can edit the *openshift* project by pushing the container images:
+
[source, bash]
----
$ oc adm policy add-role-to-user admin <admin_username> -n openshift
----

. On a master host, obtain the service address of your Docker registry:
+
[source, bash]
----
$ export REGISTRY=$(oc get service -n default \
    docker-registry --output=go-template='{{.spec.clusterIP}}{{"\n"}}')
----

. Tag all of the builder images that you synced and exported before
pushing them into the {product-title} Docker registry. For example, if you
synced and exported only the Tomcat image:
+
[source, bash]
----
$ docker tag \
registry.access.redhat.com/jboss-webserver-3/webserver30-tomcat7-openshift:1.1 \
$REGISTRY:5000/openshift/webserver30-tomcat7-openshift:1.1
$ docker tag \
registry.access.redhat.com/jboss-webserver-3/webserver30-tomcat7-openshift:latest \
$REGISTRY:5000/openshift/webserver30-tomcat7-openshift:1.2
$ docker tag \
registry.access.redhat.com/jboss-webserver-3/webserver30-tomcat7-openshift:latest \
$REGISTRY:5000/openshift/webserver30-tomcat7-openshift:latest
----

. Modify the image streams to reference your image registry. During
installation, the image streams are created in the *openshift* project by
loading data from the *_/usr/share/openshift/examples_* directory.

.. Delete the existing image streams:
+
[source, bash]
----
$ oc delete is -n openshift --all
----

.. Back up the files in the *_/usr/share/openshift/examples/_* directory.

.. In the *_image-streams-rhel7.json_* file in the
*_/usr/share/openshift/examples/image-streams_* directory, set the image `name`
in the `spec` stanza for each builder image stream to reference your internal
Docker registry.
+
Use the following format for each `name`:
+
----
<registry_ip>:5000/openshift/<image_name>
----
+
Be sure to use the correct IP address for your registry IP, and note that the
repository name is *openshift*.
+
For example, change:
+
----
"from": {
  "kind": "DockerImage",
  "name": "registry.access.redhat.com/rhscl/httpd-24-rhel7"
}
----
+
to:
+
----
"from": {
  "kind": "DockerImage",
  "name": "172.30.69.44:5000/openshift/httpd-24-rhel7"
}
----

.. Set the image `name` in the `spec` stanza for each JBoss image stream in the
*_/usr/share/openshift/examples/xpaas-streams/jboss-image-streams.json_* file
to reference your internal Docker registry.

. Load the container images:

.. Log in to the Docker registry using the token for user that you created and 
the registry service IP address:
+
[source, bash]
----
$ docker login -u adminuser -e mailto:adminuser@abc.com \
   -p $MYTOKEN $REGISTRY:5000
----

.. Push the Docker images:
+
[source, bash]
----
$ docker push $REGISTRY:5000/openshift/webserver30-tomcat7-openshift:1.1
$ docker push $REGISTRY:5000/openshift/webserver30-tomcat7-openshift:1.2
$ docker push $REGISTRY:5000/openshift/webserver30-tomcat7-openshift:latest
----

.. Load the updated image stream definitions:
+
[source, bash]
----
$ oc create -f /usr/share/openshift/examples/image-streams/image-streams-rhel7.json -n openshift
$ oc create -f /usr/share/openshift/examples/xpaas-streams/jboss-image-streams.json -n openshift
----

.. Verify that all the image streams use the correct tags:
+
[source, bash]
----
$ oc get imagestreams -n openshift
NAME                                 DOCKER REPO                                                      TAGS                                     UPDATED
jboss-webserver30-tomcat7-openshift  $REGISTRY/jboss-webserver-3/webserver30-jboss-tomcat7-openshift  1.1,1.1-2,1.1-6 + 2 more...              2 weeks ago
...
----

////
[[disconnected-installing-a-router]]
== Installing a Router

At this point, the {product-title} environment is almost ready for use. It is
likely that you will want to
xref:../install_config/router/index.adoc#install-config-router-overview[install and configure a
router].
////
