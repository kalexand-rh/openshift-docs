// Module included in the following assemblies:
//
// * installing/install_config/installing-restricted-networks-preparations.adoc
// * openshift_images/samples-operator-alt-registry.adoc
// * installing/installing-rhv-restricted-network.adoc

[id="installation-mirror-repository_{context}"]
= Mirroring the {product-title} image repository

Mirror the {product-title} image repository to a local container registry, or _mirror registry_, to use during cluster installation or upgrade.

.Prerequisites

* Your workstation has internet access.
+
[IMPORTANT]
====
If your mirror registry host can access to the Internet, complete these steps on that host.
====
* You configured a container image registry to use in your restricted network to host the mirrored images and can access the certificate and credentials that you configured.
ifndef::openshift-origin[]
* You downloaded the pull secret from the
link:https://console.redhat.com/openshift/install/pull-secret[Pull Secret] page on the {cloud-redhat-com} site and modified it to include authentication to your mirror repository.
endif::[]
ifdef::openshift-origin[]
* You created a pull secret for your mirror repository.
endif::[]

* If you use self-signed certificates that do not set a Subject Alternative Name, you must precede the `oc` commands in this procedure with `GODEBUG=x509ignoreCN=0`. If you do not set this variable, the `oc` commands will fail with the following error:
+
[source,terminal]
----
x509: certificate relies on legacy Common Name field, use SANs or temporarily enable Common Name matching with GODEBUG=x509ignoreCN=0
----

.Procedure

. Review the
link:https://access.redhat.com/downloads/content/290/[{product-title} downloads page]
to determine the version of {product-title} that you want to install and determine the corresponding tag on the link:https://quay.io/repository/openshift-release-dev/ocp-release?tab=tags[Repository Tags] page.

. Set the required environment variables.
.. Create the following `bash` script to set the variables, and name it `environment-variables.sh`.
+
[source,sh]
----
#!/bin/sh
#
# Simple script to export a list of variables
# Each variable created is given the export attribute
# and made available to the environment for subsequent commands
# set -a or set -o allexport, either command syntax will work.
set -a #export all defined variables
OCP_RELEASE='<release_version>' <1>
LOCAL_REGISTRY='<local_registry_host_name>:<local_registry_host_port>' <2>
LOCAL_REPOSITORY='<local_repository_name>' <3>
PRODUCT_REPO='openshift-release-dev' <4>
PRODUCT_REPO='openshift'
LOCAL_SECRET_JSON='<path_to_pull_secret>' <5>
ifndef::openshift-origin[]
RELEASE_NAME='ocp-release' <6>
endif::[]
ifdef::openshift-origin[]
RELEASE_NAME='okd' <6>
endif::[]
REMOVABLE_MEDIA_PATH='<path>' <7>
ifndef::openshift-origin[]
ARCHITECTURE='<server_architecture>' <8>
endif::[]
set +a #shut off export of defined variables
# alternatively set +o allexport
#
----
<1> For `<release_version>`, specify the tag that corresponds to the version of {product-title} to install, such as `4.5.4`.
<2> For `<local_registry_host_name>`, specify the registry domain name for your mirror repository, and for `<local_registry_host_port>`, specify the port that it serves content on.
<3> For `<local_repository_name>`, specify the name of the repository to create in your mirror registry, such as `ocp4/openshift4`.
<4> For a production release, you must specify `openshift-release-dev`.
<5> For `<path_to_pull_secret>`, specify the absolute path to and file name of the pull secret for the mirror registry that you created.
ifndef::openshift-origin[]
<6> For a production release, you must specify `ocp-release`.
endif::[]
ifdef::openshift-origin[]
<6> You must specify `okd`.
endif::[]
<7> For `<path>`, specify the full path, including the initial forward slash (/) character.
<8> For `<server_architecture>`, specify the type of architecture for your server, such as `x86_64`.

.. To apply the environment variables, run the script:
+
[source,terminal]
----
$ . ./environment_variables.sh
----

. Mirror the version images to the mirror registry:
** If your workstation does not also host mirror registry, take the following actions:
... Connect the removable media to your workstation.
... Review the images and configuration manifests to mirror:
+
ifdef::openshift-origin[]
[source,terminal]
----
$ oc adm release mirror -a ${LOCAL_SECRET_JSON}  \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE} --dry-run
----
endif::[]
ifndef::openshift-origin[]
[source,terminal]
----
$ oc adm release mirror -a ${LOCAL_SECRET_JSON}  \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE} --dry-run
----
endif::[]

... Record the entire `imageContentSources` section from the output of the previous
command. The information about your mirrors is unique to your mirrored repository, and you must add the `imageContentSources` section to the `install-config.yaml` file during installation.
... Mirror the images to a directory on the removable media:
+
ifdef::openshift-origin[]
[source,terminal]
----
$ oc adm release mirror -a ${LOCAL_SECRET_JSON} --to-dir=${REMOVABLE_MEDIA_PATH}/mirror quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}
----
endif::[]
ifndef::openshift-origin[]
[source,terminal]
----
$ oc adm release mirror -a ${LOCAL_SECRET_JSON} --to-dir=${REMOVABLE_MEDIA_PATH}/mirror quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE}
----
endif::[]

... Take the media to the restricted network environment and upload the images to the mirror registry.
+
[source,terminal]
----
$ oc image mirror -a ${LOCAL_SECRET_JSON} --from-dir=${REMOVABLE_MEDIA_PATH}/mirror "file://openshift/release:${OCP_RELEASE}*" ${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} <1>
----
+
<1> For `REMOVABLE_MEDIA_PATH`, you must use the same path that you specified when you mirrored the images.

** If your mirror registry host can access the internet, take the following actions:
... To directly push the release images to the mirror registry, enter the following command:
+
ifdef::openshift-origin[]
[source,terminal]
----
$ oc adm release mirror -a ${LOCAL_SECRET_JSON}  \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}
----
endif::[]
ifndef::openshift-origin[]
[source,terminal]
----
$ oc adm release mirror -a ${LOCAL_SECRET_JSON}  \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE}
----
endif::[]
+
This command pulls the release information as a digest, and its output includes
the `imageContentSources` data that you require when you install your cluster.

... Record the entire `imageContentSources` section from the output of the previous
command. The information about your mirrors is unique to your mirrored repository, and you must add the `imageContentSources` section to the `install-config.yaml` file during installation.
+
[NOTE]
====
The image name gets patched to Quay.io during the mirroring process, and the podman images will show Quay.io in the registry on the bootstrap virtual machine.
====

. Create the installation program that is based on the content that you
mirrored. On the mirror registry host, extract the installation program and pin it to the release.
+
[IMPORTANT]
====
To ensure that you use the correct images for the version of {product-title}
that you selected, you must extract the installation program from the mirrored
content.
====
+
** If your local registry host does not have internet access, run the following command:
+
[source,terminal]
----
$ oc adm release extract -a ${LOCAL_SECRET_JSON} --command=openshift-install "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}"
----
** If your local registry host has internet access, run the following command:
+
ifdef::openshift-origin[]
[source,terminal]
----
$ oc adm release extract -a ${LOCAL_SECRET_JSON} --command=openshift-install "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}"
----
endif::[]
ifndef::openshift-origin[]
[source,terminal]
----
$ oc adm release extract -a ${LOCAL_SECRET_JSON} --command=openshift-install "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE}"
----
endif::[]
+
[NOTE]
====
You must perform this step on a machine with an active internet connection.
====

. For clusters on {rh-virtualization-first} that use installer-provisioned infrastructure, run the following command:
+
[source,terminal]
----
$ openshift-install
----
