// Module included in the following assemblies:
//
// * installing/installing_restricted_networks/installing-restricted-networks-preparations.adoc
// * updating/updating-restricted-network.adoc

ifeval::["{context}" == "installing-restricted-networks-preparations"]
:restricted:
:install:
endif::[]
ifeval::["{context}" == "updating-restricted-network"]
:restricted:
:update:
endif::[]

ifdef::install[]
[id="installation-mirror-repository_{context}"]
= Mirroring the {product-title} image repository

Mirror the {product-title} image repository to use during cluster installation.

.Prerequisites

* You configured a mirror registry to use in your restricted network and
can access the certificate and credentials that you configured.
* You downloaded the pull secret from the
link:https://cloud.redhat.com/openshift/install/pull-secret[Pull Secret] page on the {cloud-redhat-com} site and modified it to include authentication to your mirror repository.
endif::install[]

ifdef::update[]
[id="update-mirror-image-repository_{context}"]
= Update the contents of the {product-title} image repository

Update the contents of the image repository that hosts the mirrored content that
you require for installing {product-title}. You must update the mirror registry
to update {product-title} to a new version.

.Prerequisites

* You have access to the mirror registry that you used to store the images that
you used to install {product-title}.
endif::update[]

.Procedure

Complete the following steps on the bastion host:

. Review the
link:https://access.redhat.com/downloads/content/290/[{product-title} downloads page]
to determine the version of {product-title} that you want to
ifdef::install[]
install.
endif::install[]
ifdef::update[]
update to.
endif::update[]

. Set the required environment variables:
+
----
$ export OCP_RELEASE=<release_version> <1>
$ export LOCAL_REGISTRY='<local_registry_host_name>:<local_registry_host_port>' <2>
$ export LOCAL_REPOSITORY='<repository_name>' <3>
$ export PRODUCT_REPO='openshift-release-dev' <4>
$ export LOCAL_SECRET_JSON='<path_to_pull_secret>' <5>
$ export RELEASE_NAME="ocp-release" <6>
----
<1> For `<release_version>`, specify the version number of {product-title} to
install, such as `4.2.1`.
ifdef::update[]
When you update {product-title}, you must specify a version number that is
higher than the version that is installed.
endif::update[]
<2> For `<local_registry_host_name>`, specify the registry domain name for your mirror
repository, and for `<local_registry_host_port>`, specify the port that it
serves content on.
<3> For `<repository_name>`, specify the name of the repository to create in your
registry, such as `ocp4/openshift4`.
<4> The repository to mirror. For a production release, you must specify
`openshift-release-dev`.
<5> For `<path_to_pull_secret>`, specify the absolute path to and file name of
the pull secret for your mirror registry that you created.
<6> The release mirror. For a production release, you must specify
`ocp-release`.

. Mirror the repository:
+
----
$ oc adm -a ${LOCAL_SECRET_JSON} release mirror \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}
----
+
This command pulls the release information as a digest, and its output includes
text that resembles the following sample:

. Record the
ifdef::install[]
`imageContentSources`
endif::install[]
ifdef::update[]
`ImageContentSourcePolicy`
endif::update[]
section from the output of the previous
command. This information is required
ifdef::install[]
during {product-title} installation.
endif::install[]
ifdef::update[]
when you update your {product-title} cluster.
endif::update[]

. Build the signature for the content that you mirrored and verify that it is
signed by an official Red Hat key:
.. Set the digest for the version to
ifdef::install[]
install:
endif::install[]
ifdef::update[]
update to:
endif::update[]
+
----
$ DIGEST="$(oc adm release info quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE} | sed -n 's/Pull From: .*@//p')" <1>
----
<1> For `<release_version>`, specify the version number of {product-title} to
that you mirrored content for.

.. Build a signature URI:
+
----
$ URI="https://mirror.openshift.com/pub/openshift-v4/signatures/openshift/release/${DIGEST/:/=}/<signature_name>" <1>
----
<1> Specify the name of the signature to store.

.. Download the signature:
+
----
$ wget "${URI}"
----

.. Download the keys that were used to sign the signature:
+
----
$ wget https://www.redhat.com/security/data/f21541eb.txt
$ wget https://www.redhat.com/security/data/fd431d51.txt
----

.. Import the keys:
+
----
$ gpg --no-default-keyring --keyring ./temp.keyring --import ./f21541eb.txt
$ gpg --no-default-keyring --keyring ./temp.keyring --import ./fd431d51.txt
----

.. Verify the signature:
+
----
$ gpg --no-default-keyring --keyring ./temp.keyring --verify <signature_name> <1>
gpg: Signature made Tue 24 Sep 2019 09:38:24 AM PDT using RSA key ID F21541EB
gpg: Good signature from "Red Hat, Inc. (beta key 2) <security@redhat.com>"
gpg:                 aka "Mark Cox Internal RSA 4096 test key <mjc@redhat.com>"
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: B08B 659E E86A F623 BC90  E8DB 938A 80CA F215 41EB
----
<1> Specify the name of the signature that you stored.

.. Confirm that the `Primary key fingerprint` value from the signature output is
is listed on the
link:https://access.redhat.com/security/team/key[Product Signing Keys]
page on the Red Hat Customer Portal.

. Mirror the repository:
+
----
$ oc adm -a ${LOCAL_SECRET_JSON} release mirror \
     --from=quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE} \
     --to=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY} \
     --to-release-image=${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}
----
+
This command pulls the release information as a digest, and its output includes the
ifdef::install[]
`imageContentSources` data that you require when you install your cluster.
endif::install[]
ifdef::update[]
`ImageContentSourcePolicy` data that you require when you update your cluster.
endif::update[]

ifdef::install[]
. To create the installation program that is based on the content that you
mirrored, extract it and pin it to the release:
+
----
$ oc adm release extract --command=openshift-install "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}"
----
+
[IMPORTANT]
====
To ensure that you use the correct images for the version of {product-title}
that you selected, you must extract the installation program from the mirrored
content.
====
endif::install[]
